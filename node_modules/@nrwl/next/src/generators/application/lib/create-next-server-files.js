"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createNextServerFiles = void 0;
const devkit_1 = require("@nrwl/devkit");
const path_1 = require("path");
let isOldNext;
try {
    require('next/dist/next-server/server/next-server');
    isOldNext = true;
}
catch (_a) {
    isOldNext = false;
}
function createNextServerFiles(host, options) {
    if (options.server) {
        const directory = (0, path_1.dirname)((0, devkit_1.joinPathFragments)(options.appProjectRoot, options.server));
        host.write((0, devkit_1.joinPathFragments)(options.appProjectRoot, options.server), `
      // @ts-check
      'use strict';

      /**
       * @typedef {import('http').Server} Server
       * @typedef {import('next/dist/server/next-server').default} DevServer
       */

      const express = require('express');

      /**
       * @param {DevServer} app
       * @param {{dev: string; dir: string; staticMarkup: boolean; quiet: boolean; conf: any; port: number;}} options
       * @returns {Promise<Server>}
       */
      module.exports = async function nextServer(app, options) {
        const handle = app.getRequestHandler();
        const expressApp = express();

        await app.prepare();

        /**
         * @returns {Promise<Server>}
         */
        return new Promise((resolve, reject) => {

          expressApp.all('*', (req, res) => {
            return handle(req, res);
          });

          const server = expressApp.listen(options.port, (err) => {
            err ? reject(err) : resolve(server);
          });
        });
      }
      `);
    }
}
exports.createNextServerFiles = createNextServerFiles;
//# sourceMappingURL=create-next-server-files.js.map