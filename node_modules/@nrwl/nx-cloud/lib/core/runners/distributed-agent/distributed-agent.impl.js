const a6_0x9284=['tasksRunnerOptions','note','executionId:\x20','../../../utilities/metric-logger','child_process','exit','random','API\x20Response','\x20--parallel\x20--max-parallel=','completed','--configuration=','readdirSync','projects','maxParallel:\x20','SIGINT','defineProperty','env','/nx.json','printRunGroupError','Other\x20Nx\x20Cloud\x20Agents\x20Detected','/lockfiles','../../../utilities/create-unchanged-value-timeout','floor','Waiting...','configuration','/tasks-hashes-','default','./node_modules/.cache/nx','next','toString','../../../utilities/environment','completed:\x20','Agent\x20was\x20terminated\x20via\x20SIGINT','existsSync','error','warn','Distributed\x20Execution\x20Terminated','criticalErrorMessage','__esModule','__awaiter','../../../utilities/nx-imports','done','join','We\x20have\x20detected\x20another\x20agent\x20with\x20this\x20ID\x20running\x20in\x20this\x20workspace.\x20This\x20should\x20not\x20happen.','CIRCLECI','message','length','../../../utilities/waiter','retryDuring:\x20','completedTasks','status','Command\x20execution\x20failed\x20(distributed\x20task\x20execution:\x20','NO_MESSAGES_TIMEOUT','mkdirSync','NO_FURTHER_TASKS_TO_RUN','includes','wait','ignore','execSync','CIRCLE_STAGE','reset','projectName','number\x20of\x20tasks:\x20','End\x20all\x20currently\x20running\x20agents,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22,\x20and\x20try\x20again.','\x20seconds','This\x20can\x20also\x20be\x20a\x20false\x20positive\x20caused\x20by\x20agents\x20that\x20did\x20not\x20shut\x20down\x20correctly.','value','SIGTERM','readFileSync','inherit','params','options','apply','./distributed-agent.api','taskId','throw','assign','startAgent','true','We\x20have\x20detected\x20other\x20agents\x20running\x20in\x20this\x20workspace.\x20This\x20can\x20cause\x20unexpected\x20behavior.','then','getTime','DistributedAgentApi','VERBOSE_LOGGING','Critical\x20Error\x20in\x20Agent:\x20\x22','completeRunGroupWithError','push','cacheDirectory','status:\x20','target','createUnchangedValueTimeout','No\x20new\x20messages\x20received\x20after\x20','writeFileSync','map','tasks','Error:','Agent\x20was\x20terminated\x20via\x20SIGTERM','CIRCLE_JOB','error:\x20','Executing:\x20\x27','executionId','getRunGroup','parse','unlinkSync','\x20--projects=','retryDuring','NX_AGENT_NAME'];(function(_0x8f9333,_0x928429){const _0x2d17cf=function(_0x28b24c){while(--_0x28b24c){_0x8f9333['push'](_0x8f9333['shift']());}};_0x2d17cf(++_0x928429);}(a6_0x9284,0x89));const a6_0x2d17=function(_0x8f9333,_0x928429){_0x8f9333=_0x8f9333-0x0;let _0x2d17cf=a6_0x9284[_0x8f9333];return _0x2d17cf;};'use strict';var __awaiter=this&&this[a6_0x2d17('0x9')]||function(_0x38ab46,_0x1c74e9,_0x42a240,_0x2293f0){function _0x263cb6(_0x7f9770){return _0x7f9770 instanceof _0x42a240?_0x7f9770:new _0x42a240(function(_0x48b7c0){_0x48b7c0(_0x7f9770);});}return new(_0x42a240||(_0x42a240=Promise))(function(_0x4d068b,_0x16d367){function _0x35022f(_0x1be339){try{_0x4bdbe(_0x2293f0[a6_0x2d17('0x69')](_0x1be339));}catch(_0x3e6dc4){_0x16d367(_0x3e6dc4);}}function _0x57bf1e(_0x2a1938){try{_0x4bdbe(_0x2293f0[a6_0x2d17('0x2d')](_0x2a1938));}catch(_0x1527e1){_0x16d367(_0x1527e1);}}function _0x4bdbe(_0x1af819){_0x1af819[a6_0x2d17('0xb')]?_0x4d068b(_0x1af819[a6_0x2d17('0x24')]):_0x263cb6(_0x1af819[a6_0x2d17('0x24')])[a6_0x2d17('0x32')](_0x35022f,_0x57bf1e);}_0x4bdbe((_0x2293f0=_0x2293f0[a6_0x2d17('0x2a')](_0x38ab46,_0x1c74e9||[]))['next']());});};Object[a6_0x2d17('0x5c')](exports,a6_0x2d17('0x8'),{'value':!![]});exports[a6_0x2d17('0x2f')]=void 0x0;const child_process_1=require(a6_0x2d17('0x51'));const fs_1=require('fs');const stripJsonComments=require('strip-json-comments');const create_unchanged_value_timeout_1=require(a6_0x2d17('0x62'));const environment_1=require(a6_0x2d17('0x0'));const metric_logger_1=require(a6_0x2d17('0x50'));const waiter_1=require(a6_0x2d17('0x11'));const print_run_group_error_1=require('../../error/print-run-group-error');const distributed_agent_api_1=require(a6_0x2d17('0x2b'));const {output,workspaceRoot}=require(a6_0x2d17('0xa'));function executeTasks(_0x29758d,_0x114040){return __awaiter(this,void 0x0,void 0x0,function*(){let _0x5bd03c=0x0;let _0x34e95d=null;const _0x14cde4=(0x0,create_unchanged_value_timeout_1[a6_0x2d17('0x3c')])({'title':a6_0x2d17('0x3d')+environment_1[a6_0x2d17('0x16')]/0x3e8+a6_0x2d17('0x22'),'timeout':environment_1['NO_MESSAGES_TIMEOUT']});const _0x1aba7a=new waiter_1['Waiter']();let _0x2231e4=[];const _0x1e8e4c=new Date();let _0x1bd197=![];while(!![]){if(environment_1[a6_0x2d17('0x35')]){output['note']({'title':'Fetching\x20tasks...'});}_0x34e95d=yield _0x114040[a6_0x2d17('0x40')](_0x34e95d?_0x34e95d[a6_0x2d17('0x46')]:null,_0x5bd03c,_0x2231e4);if(environment_1[a6_0x2d17('0x35')]){output[a6_0x2d17('0x4e')]({'title':a6_0x2d17('0x54'),'bodyLines':[a6_0x2d17('0x1')+_0x34e95d[a6_0x2d17('0x56')],a6_0x2d17('0x3a')+_0x34e95d[a6_0x2d17('0x14')],a6_0x2d17('0x12')+_0x34e95d[a6_0x2d17('0x4b')],a6_0x2d17('0x4f')+_0x34e95d[a6_0x2d17('0x46')],a6_0x2d17('0x20')+_0x34e95d[a6_0x2d17('0x40')]['length'],a6_0x2d17('0x44')+_0x34e95d[a6_0x2d17('0x7')],a6_0x2d17('0x5a')+_0x34e95d['maxParallel']]});}if(_0x34e95d[a6_0x2d17('0x7')]){output[a6_0x2d17('0x4')]({'title':a6_0x2d17('0x6'),'bodyLines':[a6_0x2d17('0x41'),_0x34e95d['criticalErrorMessage']]});process[a6_0x2d17('0x52')](0x0);}if((_0x34e95d===null||_0x34e95d===void 0x0?void 0x0:_0x34e95d[a6_0x2d17('0x4b')])&&(_0x34e95d===null||_0x34e95d===void 0x0?void 0x0:_0x34e95d[a6_0x2d17('0x4b')])!==0x0&&!_0x1bd197&&new Date()[a6_0x2d17('0x33')]()-_0x1e8e4c[a6_0x2d17('0x33')]()>_0x34e95d[a6_0x2d17('0x4b')]){yield _0x1aba7a[a6_0x2d17('0x1a')]();continue;}if((_0x34e95d===null||_0x34e95d===void 0x0?void 0x0:_0x34e95d[a6_0x2d17('0x14')])!==undefined){if(_0x34e95d[a6_0x2d17('0x14')]==='RUN_GROUP_COMPLETED'||_0x34e95d['status']===a6_0x2d17('0x18')){return;}}else if(_0x34e95d[a6_0x2d17('0x56')]){return;}_0x14cde4(_0x34e95d[a6_0x2d17('0x40')][a6_0x2d17('0x3f')](_0x4657e6=>_0x4657e6[a6_0x2d17('0x2c')])['join'](''));if(!_0x34e95d[a6_0x2d17('0x46')]){if(environment_1[a6_0x2d17('0x35')]){output[a6_0x2d17('0x4e')]({'title':a6_0x2d17('0x64')});}yield _0x1aba7a[a6_0x2d17('0x1a')]();_0x5bd03c=0x0;_0x2231e4=[];continue;}_0x1aba7a[a6_0x2d17('0x1e')]();_0x1bd197=!![];const _0xfad46b=invokeTasksUsingRunMany(_0x29758d,_0x34e95d[a6_0x2d17('0x46')],_0x34e95d[a6_0x2d17('0x40')],_0x34e95d['maxParallel']);_0x5bd03c=_0xfad46b['completedStatusCode'];_0x2231e4=_0xfad46b[a6_0x2d17('0x13')];}});}function readCompletedTasks(_0x2c4273,_0xaeed96){const _0x57bc1a=a6_0x2d17('0x15')+_0xaeed96+').\x20Tasks\x20hashes\x20haven\x27t\x20been\x20recorded.';let _0x28db45;try{const _0x4c136e=_0x2c4273[a6_0x2d17('0x39')]||a6_0x2d17('0x68');const _0x2b3820=_0x4c136e+a6_0x2d17('0x66')+_0xaeed96;_0x28db45=JSON[a6_0x2d17('0x48')]((0x0,fs_1[a6_0x2d17('0x26')])(_0x2b3820)['toString']());(0x0,fs_1[a6_0x2d17('0x49')])(_0x2b3820);}catch(_0x4774ff){throw new Error(_0x57bc1a);}if(_0x28db45[a6_0x2d17('0x10')]==0x0){throw new Error(_0x57bc1a);}return _0x28db45;}function invokeTasksUsingRunMany(_0x4f64fa,_0x43eb2e,_0x2853b2,_0x559aa9){let _0x1ed4f1=0x0;const _0x2a3d7d=[];for(const _0x3790a4 of groupByTarget(_0x2853b2)){const _0x4e7888=_0x3790a4[a6_0x2d17('0x65')]?a6_0x2d17('0x57')+_0x3790a4[a6_0x2d17('0x65')]:'';const _0x5f5ab8=_0x559aa9>0x1?a6_0x2d17('0x55')+_0x559aa9:'';const _0x4035b9='npx\x20nx\x20run-many\x20--target='+_0x3790a4[a6_0x2d17('0x3b')]+'\x20'+_0x4e7888+a6_0x2d17('0x4a')+_0x3790a4[a6_0x2d17('0x59')][a6_0x2d17('0xc')](',')+'\x20'+_0x3790a4[a6_0x2d17('0x28')]+_0x5f5ab8;if(environment_1[a6_0x2d17('0x35')]){output['note']({'title':a6_0x2d17('0x45')+_0x4035b9+'\x27'});}try{(0x0,child_process_1[a6_0x2d17('0x1c')])(_0x4035b9,{'stdio':[a6_0x2d17('0x1b'),a6_0x2d17('0x27'),a6_0x2d17('0x27')],'env':Object[a6_0x2d17('0x2e')](Object[a6_0x2d17('0x2e')]({},process['env']),{'NX_CACHE_FAILURES':a6_0x2d17('0x30'),'NX_CLOUD_DISTRIBUTED_EXECUTION_ID':_0x43eb2e,'NX_STREAM_OUTPUT':a6_0x2d17('0x30'),'NX_PREFIX_OUTPUT':a6_0x2d17('0x30')})});_0x2a3d7d[a6_0x2d17('0x38')](...readCompletedTasks(_0x4f64fa,_0x43eb2e));}catch(_0x1b3307){if(_0x1b3307[a6_0x2d17('0x14')]===environment_1['DISTRIBUTED_TASK_EXECUTION_INTERNAL_ERROR_STATUS_CODE']){throw _0x1b3307;}else{_0x1ed4f1=0x1;_0x2a3d7d[a6_0x2d17('0x38')](...readCompletedTasks(_0x4f64fa,_0x43eb2e));}}}return{'completedStatusCode':_0x1ed4f1,'completedTasks':_0x2a3d7d};}function groupByTarget(_0x18a2d6){const _0x406a52=[];_0x18a2d6['forEach'](_0x5384df=>{const _0x39ead6=_0x406a52['find'](_0x41161=>_0x41161[a6_0x2d17('0x3b')]===_0x5384df[a6_0x2d17('0x3b')]&&_0x41161[a6_0x2d17('0x65')]===_0x5384df[a6_0x2d17('0x65')]);if(_0x39ead6){_0x39ead6['projects'][a6_0x2d17('0x38')](_0x5384df[a6_0x2d17('0x1f')]);}else{_0x406a52[a6_0x2d17('0x38')]({'target':_0x5384df[a6_0x2d17('0x3b')],'projects':[_0x5384df['projectName']],'params':_0x5384df['params'],'configuration':_0x5384df[a6_0x2d17('0x65')]});}});return _0x406a52;}function getAgentName(){if(process[a6_0x2d17('0x5d')][a6_0x2d17('0x4c')]!==undefined){return process['env'][a6_0x2d17('0x4c')];}else if(process[a6_0x2d17('0x5d')][a6_0x2d17('0xe')]!==undefined&&process[a6_0x2d17('0x5d')][a6_0x2d17('0x1d')]){return process[a6_0x2d17('0x5d')][a6_0x2d17('0x1d')];}else if(process[a6_0x2d17('0x5d')][a6_0x2d17('0xe')]!==undefined&&process[a6_0x2d17('0x5d')][a6_0x2d17('0x43')]){return process['env'][a6_0x2d17('0x43')];}else{return'Agent\x20'+Math[a6_0x2d17('0x63')](Math[a6_0x2d17('0x53')]()*0x186a0);}}function createAgentLockfileAndSetUpListeners(_0x5d9cb5,_0x3f4b4f,_0x33c09f){const _0x311912=_0x3f4b4f[a6_0x2d17('0x39')]||a6_0x2d17('0x68');const _0x5f4a20=_0x311912+a6_0x2d17('0x61');const _0x2aef97=_0x5f4a20+'/'+_0x33c09f+'.lock';if(!(0x0,fs_1[a6_0x2d17('0x3')])(_0x5f4a20)){(0x0,fs_1[a6_0x2d17('0x17')])(_0x5f4a20,{'recursive':!![]});}const _0x1145ed=(0x0,fs_1[a6_0x2d17('0x58')])(_0x5f4a20);if(_0x1145ed['length']){if(_0x1145ed[a6_0x2d17('0x19')](_0x33c09f+'.lock')){output[a6_0x2d17('0x4')]({'title':'Duplicate\x20Agent\x20ID\x20Detected','bodyLines':[a6_0x2d17('0xd'),'',a6_0x2d17('0x21')]});process[a6_0x2d17('0x52')](0x1);}output[a6_0x2d17('0x5')]({'title':a6_0x2d17('0x60'),'bodyLines':[a6_0x2d17('0x31'),'',a6_0x2d17('0x23'),'If\x20you\x20believe\x20this\x20is\x20the\x20case,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22.']});}(0x0,fs_1[a6_0x2d17('0x3e')])(_0x2aef97,'');process['on'](a6_0x2d17('0x52'),_0x4a0e7f=>{cleanupAgentLockfile(_0x2aef97,_0x4a0e7f);});process['on'](a6_0x2d17('0x25'),()=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x5d9cb5[a6_0x2d17('0x37')](a6_0x2d17('0x42'));cleanupAgentLockfile(_0x2aef97,0x1);}));process['on'](a6_0x2d17('0x5b'),()=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x5d9cb5[a6_0x2d17('0x37')](a6_0x2d17('0x2'));cleanupAgentLockfile(_0x2aef97,0x1);}));}function cleanupAgentLockfile(_0x442224,_0x318049){if((0x0,fs_1[a6_0x2d17('0x3')])(_0x442224)){(0x0,fs_1[a6_0x2d17('0x49')])(_0x442224);process['exit'](_0x318049);}}function startAgent(){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x2da287=(0x0,environment_1[a6_0x2d17('0x47')])();if(!_0x2da287){(0x0,print_run_group_error_1[a6_0x2d17('0x5f')])();return process['exit'](0x1);}output[a6_0x2d17('0x4e')]({'title':'Starting\x20an\x20agent\x20for\x20running\x20Nx\x20tasks'});const _0x3b0789=JSON['parse'](stripJsonComments((0x0,fs_1[a6_0x2d17('0x26')])(workspaceRoot+a6_0x2d17('0x5e'))[a6_0x2d17('0x6a')]()))[a6_0x2d17('0x4d')][a6_0x2d17('0x67')][a6_0x2d17('0x29')];const _0x54c9b0=getAgentName();const _0x5bbd82=new distributed_agent_api_1[(a6_0x2d17('0x34'))](_0x3b0789,_0x2da287,_0x54c9b0);createAgentLockfileAndSetUpListeners(_0x5bbd82,_0x3b0789,_0x54c9b0);return executeTasks(_0x3b0789,_0x5bbd82)['then'](_0x555766=>__awaiter(this,void 0x0,void 0x0,function*(){yield(0x0,metric_logger_1['submitRunMetrics'])(_0x3b0789);return _0x555766;}))['catch'](_0x412c17=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x5bbd82[a6_0x2d17('0x37')](a6_0x2d17('0x36')+_0x412c17[a6_0x2d17('0xf')]+'\x22');throw _0x412c17;}));});}exports[a6_0x2d17('0x2f')]=startAgent;